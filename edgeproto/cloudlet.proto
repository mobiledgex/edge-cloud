// Cloudlet proto

syntax = "proto3";
package edgeproto;

import "google/api/annotations.proto";
import "github.com/mobiledgex/edge-cloud/protogen/protogen.proto";
import "github.com/mobiledgex/edge-cloud/protoc-gen-cmd/protocmd/protocmd.proto";
import "operator.proto";
import "result.proto";
import "common.proto";
import "github.com/mobiledgex/edge-cloud/d-match-engine/dme-proto/loc.proto";
import "github.com/gogo/protobuf/gogoproto/gogo.proto";

// CloudletKey uniquely identifies a Cloudlet.
message CloudletKey {
  // Operator of the cloudlet site
  OperatorKey operator_key = 1 [(gogoproto.nullable) = false];
  // Name of the cloudlet
  string name = 2;
  option (protogen.generate_matches) = true;
  option (protogen.obj_key) = true;
  option (gogoproto.gostring) = true;
}

// properites common to all cloudlets
message CloudletInfraCommon{
    // the mex docker registry, e.g.  registry.mobiledgex.net:5000. 
    string docker_registry = 1;
     // DNS Zone
    string DNS_zone = 2;
    // registry file server contains files which get pulled on instantiation such as certs and images
    string registry_file_server = 3;
    // Cloudflare key
    string CF_key = 4; //MEX_CF_KEY
    // Cloudflare key
    string CF_user = 5; //MEX_CF_KEY
    // Docker registry password
    string docker_reg_pass = 6; //MEX_DOCKER_REG_PASS
}

message AzureProperties{
  // azure region e.g. uswest2
  string location = 1;
  // azure resource group
  string resource_group = 2;
  // azure username
  string user_name = 3;
  // azure password
  string password = 4;
}

message GcpProperties{
  // gcp project for billing
  string project = 1;
  // availability zone
  string zone = 2;
}

message OpenStackProperties{
  // name of the external network, e.g. external-network-shared
  string OS_external_network_name = 1; 
  //openstack image , e.g. mobiledgex
  string OS_image_name = 2;
  // openstack router
  string OS_external_router_name = 3;
  // openstack internal network
  string OS_mex_network = 4;
  // openstack network scheme
  string OS_network_scheme = 5;
  // openrc env vars 
  map<string, string> open_rc_vars = 6;
}

message CloudletInfraProperties{
    // what kind of infrastructure: Azure, GCP, Openstack
    string cloudlet_kind = 1;
    //name and version of the docker image container image that mexos runs in
    string mexos_container_image_name = 2;
    // openstack
    OpenStackProperties openstack_properties = 3;
    // azure
    AzureProperties azure_properties = 4;
    // gcp
    GcpProperties gcp_properties = 5;
}

// A Cloudlet is a set of compute resources at a particular location, typically an Operator's regional data center, or a cell tower. The Cloudlet is managed by a Cloudlet Resource Manager, which communicates with the Mobiledgex Controller and allows AppInsts (application instances) to be instantiated on the Cloudlet.
// A Cloudlet will be created by either a Mobiledgex admin or an Operator that provides the Cloudlet.
message Cloudlet {
  // Fields are used for the Update API to specify which fields to apply
  repeated string fields = 1;
  // Unique identifier key
  CloudletKey key = 2 [(gogoproto.nullable) = false];
  // URI to use to connect to and create and administer the Cloudlet. This is not the URI for applications clients to access their back-end instances.
  string access_uri = 4 [(protogen.test_update) = true];
  // Location of the Cloudlet site
  distributed_match_engine.Loc location = 5 [(gogoproto.nullable) = false];
  // Type of IP support provided by Cloudlet (see IpSupport)
  IpSupport ip_support = 6;
  // List of static IPs for static IP support
  string static_ips = 7;
  // Number of dynamic IPs available for dynamic IP support
  int32 num_dynamic_ips = 8;
  // Certs for accessing cloudlet site

  option (protogen.generate_matches) = true;
  option (protogen.generate_cud) = true;
  option (protogen.generate_cud_test) = true;
  option (protogen.generate_cud_streamout) = true;
  option (protogen.generate_cache) = true;
  option (protogen.notify_cache) = true;
  option (protogen.notify_custom_update) = true;
  option (protocmd.noconfig) = "Location.HorizontalAccuracy,Location.VerticalAccuracy,Location.Course,Location.Speed,Location.Timestamp";
}

service CloudletApi {
  // Create a Cloudlet
  rpc CreateCloudlet(Cloudlet) returns (stream Result) {
    option (google.api.http) = {
      post: "/create/cloudlet"
      body: "*"
    };
    option (protogen.mc2_api) = "ResourceCloudlets,ActionManage,Key.OperatorKey.Name";
  }
  // Delete a Cloudlet
  rpc DeleteCloudlet(Cloudlet) returns (stream Result) {
    option (google.api.http) = {
      post: "/delete/cloudet"
      body: "*"
    };
    option (protocmd.stream_out_incremental) = true;
    option (protogen.mc2_api) = "ResourceCloudlets,ActionManage,Key.OperatorKey.Name";
  }
  // Update a Cloudlet
  rpc UpdateCloudlet(Cloudlet) returns (stream Result) {
    option (google.api.http) = {
      post: "/update/cloudlet"
      body: "*"
    };
    option (protogen.mc2_api) = "ResourceCloudlets,ActionManage,Key.OperatorKey.Name";
  }
  // Show Cloudlets
  rpc ShowCloudlet(Cloudlet) returns (stream Cloudlet) {
    option (google.api.http) = {
      post: "/show/cloudlet"
      body: "*"
    };
    option (protogen.mc2_api) = "ResourceCloudlets,ActionView,Key.OperatorKey.Name";
  }
}

// CloudletState is the state of the Cloudlet.
enum CloudletState {
  // Unknown
  CloudletStateUnknown = 0;
  // Create/Delete/Update encountered errors (see Errors field of CloudletInfo)
  CloudletStateErrors = 1;
  // Cloudlet is created and ready
  CloudletStateReady = 2;
  // Cloudlet is offline (unreachable)
  CloudletStateOffline = 3;
  // Cloudlet is not present
  CloudletStateNotPresent = 4;
}

// CloudletInfo provides information from the Cloudlet Resource Manager about the state of the Cloudlet.
message CloudletInfo {
  // Fields are used for the Update API to specify which fields to apply
  repeated string fields = 1;
  // Unique identifier key
  CloudletKey key = 2 [(gogoproto.nullable) = false];
  // State of cloudlet
  CloudletState state = 3;
  // Id of client assigned by server (internal use only)
  int64 notify_id = 4;
  // Connected controller unique id
  string controller = 5;
  // Maximum Ram in MB on the Cloudlet
  uint64 os_max_ram = 6;
  // Maximum number of VCPU cores on the Cloudlet
  uint64 os_max_vcores = 7;
  // Maximum amount of disk in GB on the Cloudlet
  uint64 os_max_vol_gb = 8;
  // Any errors encountered while making changes to the Cloudlet
  repeated string errors = 9;
  option (protogen.generate_matches) = true;
  option (protogen.generate_cud) = true;
  option (protogen.generate_cache) = true;
  option (protogen.generate_show_test) = true;
  option (protogen.notify_cache) = true;
  option (protogen.notify_flush) = true;
  option (protogen.notify_recv_hook) = true;
}

service CloudletInfoApi {
  // Show CloudletInfos
  rpc ShowCloudletInfo(CloudletInfo) returns (stream CloudletInfo) {
    option (google.api.http) = {
      post: "/show/cloudletinfo"
      body: "*"
    };
    option (protogen.mc2_api) = "ResourceCloudlets,ActionView,Key.OperatorKey.Name";
  }
  // Inject (create) a CloudletInfo for regression testing
  rpc InjectCloudletInfo(CloudletInfo) returns (Result) {}
  // Evict (delete) a CloudletInfo for regression testing
  rpc EvictCloudletInfo(CloudletInfo) returns (Result) {}
}

// (TODO) CloudletMetrics provide metrics collected about the Cloudlet. They are sent to a metrics collector for analytics. They are not stored in the persistent distributed database, but are stored as a time series in some other database or files.
message CloudletMetrics {
  // what goes here?
  uint64 foo = 5;
}

service CloudletMetricsApi {
  // Show Cloudlet metrics
  rpc ShowCloudletMetrics(CloudletMetrics) returns (stream CloudletMetrics) {
    option (google.api.http) = {
      post: "/show/cloudletmetrics"
      body: "*"
    };
  }
}
