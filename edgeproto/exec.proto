syntax = "proto3";
package edgeproto;

import "github.com/mobiledgex/edge-cloud/protogen/protogen.proto";
import "gogoproto/gogo.proto";
import "appinst.proto";

message RunCmd {
  // Command or Shell
  string command = 1;
}

message RunVMConsole {
  // VM Console URL
  string url = 1 [(protogen.backend) = true, (protogen.hidetag) = "nocmp"];
}

message ShowLog {
  // Show logs since either a duration ago (5s, 2m, 3h) or a timestamp (RFC3339)
  string since = 1;
  // Show only a recent number of lines
  int32 tail = 2;
  // Show timestamps
  bool timestamps = 3;
  // Stream data
  bool follow = 4;
}

// VMType is the type of VM to access in the Cloudlet
enum VMType {
  // Unknown VM
  UNKNOWN_VM = 0;
  // Platform VM
  PLATFORM_VM = 1;
  // Shared RootLB VM
  SHARED_ROOTLB_VM = 2;
  // Dedicated RootLB VM
  DEDICATED_ROOTLB_VM = 3;
}

// ExecRequest is a common struct for enabling a webrtc connection do execute some work on a container.
message ExecRequest {
  // Target AppInst
  AppInstKey app_inst_key = 1 [(gogoproto.nullable) = false];
  // ContainerId is the name or ID of the target container, if applicable
  string container_id = 3;
  // WebRTC Offer
  string offer = 4 [(protogen.backend) = true, (protogen.hidetag) = "nocmp"];
  // WebRTC Answer
  string answer = 5 [(protogen.backend) = true, (protogen.hidetag) = "nocmp"];
  // Any error message
  string err = 6;
  // Command to run (one of)
  RunCmd cmd = 9;
  // Show log (one of)
  ShowLog log = 10;
  // Console (one of)
  RunVMConsole console = 11;
  // Timeout
  int64 timeout = 12 [(gogoproto.casttype) = "Duration"];
  // WebRTC
  bool webrtc = 13;
  // Access URL
  string access_url = 14 [(protogen.backend) = true];
  // EdgeTurn Server Address
  string edge_turn_addr = 15 [(protogen.backend) = true];
  // VM Type
  VMType vm_type = 16;
  option (protogen.notify_message) = true;
  option (protogen.notify_custom_update) = true;
  option (protogen.noconfig) = "Offer,Answer,Err,Console.Url,Timeout,AccessUrl,EdgeTurnAddr";
  option (protogen.alias) = "appname=AppInstKey.AppKey.Name,appvers=AppInstKey.AppKey.Version,app-org=AppInstKey.AppKey.Organization,cluster=AppInstKey.ClusterInstKey.ClusterKey.Name,cluster-org=AppInstKey.ClusterInstKey.Organization,cloudlet=AppInstKey.ClusterInstKey.CloudletKey.Name,cloudlet-org=AppInstKey.ClusterInstKey.CloudletKey.Organization,command=Cmd.Command,since=Log.Since,tail=Log.Tail,timestamps=Log.Timestamps,follow=Log.Follow";
  option (protogen.also_required) = "AppInstKey,VmType";
}

service ExecApi {
  // Run a Command or Shell on a container
  rpc RunCommand(ExecRequest) returns (ExecRequest) {
    option (protogen.mc2_api) = "ResourceAppInsts,ActionManage,AppInstKey.AppKey.Organization";
    option (protogen.method_noconfig) = "Offer,Answer,Err,Timeout,Log,Console,AccessUrl,EdgeTurnAddr,VmType";
    option (protogen.method_also_required) = "AppInstKey,Cmd.Command";
    option (protogen.method_not_required) = "AppInstKey.ClusterInstKey.Organization";
  }
  // Run console on a VM
  rpc RunConsole(ExecRequest) returns (ExecRequest) {
    option (protogen.mc2_api) = "ResourceAppInsts,ActionManage,AppInstKey.AppKey.Organization";
    option (protogen.method_noconfig) = "Offer,Answer,Err,Timeout,Log,Cmd,Console,AccessUrl,EdgeTurnAddr,VmType";
    option (protogen.method_not_required) = "AppInstKey.ClusterInstKey.Organization";
  }
  // View logs for AppInst
  rpc ShowLogs(ExecRequest) returns (ExecRequest) {
    option (protogen.mc2_api) = "ResourceAppInsts,ActionView,AppInstKey.AppKey.Organization";
    option (protogen.method_noconfig) = "Offer,Answer,Err,Timeout,Cmd,Console,AccessUrl,EdgeTurnAddr,VmType";
    option (protogen.method_not_required) = "AppInstKey.ClusterInstKey.Organization";
    option (protogen.non_standard_show) = true;
  }
  // Access internal VMs of Cloudlet
  rpc AccessCloudlet(ExecRequest) returns (ExecRequest) {
    option (protogen.mc2_api) = "ResourceCloudlets,ActionManage,";
    option (protogen.method_noconfig) = "Offer,Answer,Err,Timeout,Cmd,Console,Log,AccessUrl,EdgeTurnAddr,Webrtc,ContainerId,AppInstKey.AppKey.Name,AppInstKey.AppKey.Version,AppInstKey.AppKey.Organization";
    option (protogen.method_not_required) = "AppInstKey.ClusterInstKey.ClusterKey.Name,AppInstKey.ClusterInstKey.Organization";
  }
  // This is used internally to forward requests to other Controllers.
  rpc SendLocalRequest(ExecRequest) returns (ExecRequest) {}
}
